--This query analyzes products by how much they are trending relative to the past through an avg_order_date_from_present field. 
--It also includes a sum product revenue field to guage relevance.
select ad.prod_id, pr.title, ad.avg_order_date_from_present, pr.product_revenue from 
    (select o.prod_id, AVG(dd.day_diff) as avg_order_date_from_present  from orderlines as o
    join(select o.orderlineid, date_part('day',(select max(orderdate)::timestamp from orderlines) - o.orderdate::timestamp) as day_diff
        from orderlines as o) as dd on o.orderlineid = dd.orderlineid
    group by o.prod_id) as ad
join (select ol.prod_id, p.title, SUM(ol.quantity*p.price) as product_revenue from orderlines as ol
    join products as p on p.prod_id=ol.prod_id 
    Group by ol.prod_id, p.title) as pr on ad.prod_id=pr.prod_id
ORder by ad.avg_order_date_from_present ASC;
